<div class="col">
    <h4 class="mb-3  bd-text-purple-bright">
        供货商列表
    </h4>
    <div class="form-inline ">
        <div class="col-12 col-md-2">
            <button class="btn btn-primary" id="btnAddShow">增加</button>
        </div>
    </div>
    <table id="grid" class="table table-striped table-bordered" cellspacing="0" width="100%">
    </table>
</div>
<div id="dialog">
    <form>
        <div class="form-group form-inline row">
            <label class="col-lg-3 control-label">供货商名称</label>
            <div class="col-lg-8">
                <input type="text" class="form-control w-100" maxlength="10" placeholder="供货商名称" name="Name" />
            </div>
        </div>
        <div class="form-group form-inline row">
            <label class="col-lg-3 control-label">邮箱</label>
            <div class="col-lg-8">
                <input type="text" class="form-control w-100" maxlength="200" placeholder="邮箱" name="Email" />
            </div>
        </div>
        <div class="form-group form-inline row">
            <label class="col-lg-3 control-label">账户类型</label>
            <div class="col-lg-8">
                <select class="form-control" name="BankType">
                    @foreach (EBankType type in Enum.GetValues(typeof(EBankType)))
                    {
                    <option value="@((int)type)">@type</option>
                    }
                </select>
            </div>
        </div>
        <div class="form-group form-inline row">
            <label class="col-lg-3 control-label">手续费率</label>
            <div class="col-lg-8">
                <input type="number" step="0.00001" min="0" class="form-control w-100" name="FeeRate" value="0" />
            </div>
        </div>
        <div class="form-group form-inline row">
            <label class="col-lg-3 control-label">账号</label>
            <div class="col-lg-8">
                <input type="text" class="form-control w-100" maxlength="40" placeholder="账号" name="BankAccount" />
            </div>
        </div>
        <div class="form-group form-inline row">
            <label class="col-lg-3 control-label">QQ号</label>
            <div class="col-lg-8">
                <input type="text" class="form-control w-100" placeholder="QQ号" name="QQ" />
            </div>
        </div>
    </form>
</div>
@section Scripts{
    <script>
        if (user ) {
        }
        else {
            location.href = "/user/login";
        }
        var esupplierBankType = @Json.Serialize(Global.EnumsDic<EBankType>());
        var dialog;
        var id = "";
        var list = null;

        $(function () {
            QueryPageList();
            $("#btnAddShow").on("click", function () {
                id = "";
                CreateDialog();
                dialog.modal("show");
            });
            $("#dialog").hide();
        });



        var grid = $('#grid').bootstrapTable(
            $.extend(baseTableoption, {
                uniqueId: "SId",
                columns: [{
                    field: 'Name',
                    title: '供货商名称'
                }, {
                    //field: 'BankType_str',
                    title: '账户类型', formatter: function (value, row, index) {
                        return  esupplierBankType[row.BankType] ;
                    }
                }, {
                    field: 'BankAccount',
                    title: '账号'
                }, {
                    //field: 'FeeRate_str',
                    title: '手续费率', formatter: function (value, row, index) {
                        return row.FeeRate.Format0(2);
                    }
                }, {
                    title: '管理', formatter: function (value, row, index) {
                        var btn = "<button onclick=\"ModifyShow('" + row.SId + "')\" class=\"btn-info btn-sm m-1\">编辑</button>";
                        btn += "<button onclick=\"Delete('" + row.SId + "')\" class=\"btn-warning btn-sm m-1\">删除</button>";
                        btn += "<a href=\"/user/order?sid=" + row.SId + "\" target=\"_blank\" class=\"btn-danger btn-sm\">(" + row.NotClose + ")未结算订单</a>";
                        btn += "<a href=\"/user/ordercloserecord/" + row.SId + "\" target=\"_blank\" class=\"btn-link btn-sm\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i>结算记录</a>";
                        return btn;
                    }
                }]
            })
        );
        QueryPageList = function () {
            var gridopt = grid.bootstrapTable("getOptions");
            CY.Ajax("SupplierPageList", {
                Token: Store.Token()
            }, {
                storeId:storeid,
                pageindex: gridopt.pageNumber,
                pagesize: gridopt.pageSize
            }, function (msg) {
                if (msg.Result) {
                    list = msg.Data.rows;
                    grid.bootstrapTable('load', msg.Data);
                }
                else {
                    alert(msg.Message);
                }
            });
        }
        
        $.validator.addMethod("qq_rule", function (value, element, params) {
            var rule = /^\d+$/g;
            return this.optional(element) || (rule.test(value));
        }, "请填数字");

        function CreateDialog() {
            dialog = bootbox.dialog({
                show: false,
                title: "商品分类",
                message: $("#dialog").html(),
                buttons: {
                    confirm: {
                        label: "保存",
                        className: "btn-success",
                        callback: function () {
                            if (dialog.find("form").valid()) {
                                CY.Ajax("SupplierSave", {
                                    Token: Store.Token()
                                }, {
                                    "storeId":storeid,
                                    "sid": id,
                                    "name": dialog.find("form").find("[name='Name']").val(),
                                    "email": dialog.find("form").find("[name='Email']").val(),
                                    "bankaccount": dialog.find("form").find("[name='BankAccount']").val(),
                                    "banktype": dialog.find("form").find("[name='BankType']").val(),
                                    "qq": dialog.find("form").find("[name='QQ']").val(),
                                    "feerate": dialog.find("form").find("[name='FeeRate']").val()
                                }, function (msg) {
                                    if (msg.Result) {
                                        $.toast("操作成功！");
                                    } else {
                                        $.toast(msg.Message);
                                    }
                                    dialog.modal("hide");
                                    QueryPageList();
                                });
                            }
                            return false;
                        }
                    }
                }
            });
            dialog.find("form").find("input[maxlength]").maxlength({
                alwaysShow: true,
                threshold: 10,
                warningClass: "badge badge-success",
                limitReachedClass: "badge badge-danger"
            });
            dialog.find("form").validate_popover({
                
                rules: {
                    Name: {
                        required: true,
                        rangelength: [2, 10],
                    },
                    Email: {
                        required: true,
                        rangelength: [4, 200],
                    },
                    BankAccount: {
                        required: true,
                        rangelength: [4, 100],
                    },
                    QQ: {
                        required: true,
                        qq_rule: true
                    }
                }
            });
        }
       

        function ModifyShow(sid) {
            id = sid;
            CreateDialog();
            for (var i = 0; i < list.length; i++) {
                if (list[i].SId == sid) {
                    dialog.find("form").FormSet(list[i]);
                    i = list.length;
                }
            }
            dialog.modal("show");
        }
        function Delete(m_id) {
            bootbox.confirm("是否确认?", function (result) {
                if (result) {
                    CY.Ajax("SupplierDelete", {
                        Token: Store.Token()
                    }, {
                        "storeId":storeid,
                        "sid": m_id
                    }, function (msg) {
                        if (msg.Result) {
                            $.toast("操作成功！");
                        } else {
                            $.toast(msg.Message);
                        }
                        QueryPageList();
                    });
                }
            });
            return false;
        }
        
    </script>
}
