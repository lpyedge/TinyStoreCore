<!--背景阴影-->
<div class="blackmask"></div>
<!--支付方式弹出窗口-->
<div class="dialog-box" id="payment" style="display:none">
    <div class="dialog-wrapper">
        <div class="dialog">
            <div class="close dialog-close">
                <i class="iconfont icon-chahao"></i>
            </div>
            <div class="title">请选择支付方式</div>
            <div class="content">
                <div class="payment row">
                    <div class="unit">
                        <a name="wechat">
                            <span class="wechat"></span>
                            微信支付
                        </a>
                    </div>
                    <div class="unit">
                        <a name="alipay">
                            <span class="alipay"></span>
                            支付宝支付
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    
    /*支付方式*/
    .payment {
        display:flex;
        justify-content: space-evenly;
    }

    .payment .unit {
        margin: 0.3rem 0.6rem;
        text-align: center
    }

    .payment span {
        width: 2.14rem;
        height: 2.14rem;
        border-radius: 0.43rem;
        margin-bottom: 0.14rem;
        display: block
    }

    .payment .wechat {
        background: url(/images/wechat.png) no-repeat center #3daf34;
        background-size: cover
    }

    .payment .alipay {
        background: url(/images/alipay.png) no-repeat center #02a8f2;
        background-size: cover
    }

</style>
<script>
    var Payment = {};
    var $payment_dialog = $("#payment .dialog");
    //todo 需要根据店铺配置的支付方式展示

    Payment.Show = function () {
        $(".blackmask,#payment").fadeIn(150);
        $payment_dialog.addClass("fadeIn-up");
        $payment_dialog.removeClass("fadeOut-up");

        //关闭付款方式选择页面
        $("#payment").find(".dialog-close").click(function () {
            $(".blackmask,#payment").fadeOut(150);
            $payment_dialog.addClass("fadeOut-up");
            $payment_dialog.removeClass("fadeIn-up");
        });

        if (arguments.length === 4) {
            Payment.orderId = undefined;
            Payment.productId = arguments[0];
            Payment.quantity = arguments[1];
            Payment.contact = arguments[2];
            Payment.message = arguments[3];

        } else if (arguments.length === 1) {
            Payment.orderId = arguments[0];
        }
    }

    Payment.AppLaunched = function (isVisibility) {
        if (!isVisibility && Payment.orderId) {
            location.href = "/o/" + Payment.orderId;
        }
    }


    $(function () {
        //支付
        $("#payment").find("[name]").on("click", function (e) {
            var payname = $(this).attr("name");
            if (payname) {
                if (Payment.orderId) {
                    CY.Ajax("OrderPay", {
                        "orderid": Payment.orderId,
                        "paymenttype": payname
                    }, function (response) {
                        if (response.code === 1) {                            
                            if (response.data && response.data.url) {
                                CY.Page.AppLaunch(msg.data.url);
                            }
                        } else if (response.code === 0){
                            $.toast("订单不存在或已经成功付款");
                        } else if (response.code === 13){
                            $.toast("服务器数据异常");
                        } else if (response.code === 15){
                            $.toast("支付方式不存在");
                        }
                    });
                } else {
                    CY.Ajax("OrderInsert",
                        {
                            "productid": Payment.productId,
                            "quantity": Payment.quantity,
                            "contact": Payment.contact,
                            "message": Payment.message,
                            "paymenttype": payname
                        },
                        function (response) {
                            if (response.code === 1) {
                                Payment.orderId = response.data.orderId;
                                if (response.data && response.data.url) {
                                    CY.Page.AppLaunch(response.data.url);
                                }
                                CY.Page.VisibilityListener(Payment.AppLaunched);
                            }
                            else if (response.code === 0) {
                                $.toast("请检查您的下单数量是否满足购买条件");
                            }else if (response.code === 11) {
                                $.toast("提交数据验证未通过");
                            }else if (response.code === 13) {
                                $.toast("服务器数据异常");
                            }else if (response.code === 15) {
                                $.toast("提交数据格式错误");
                            }
                        });
                }
            }
            else {
                $.toast("请完善信息！");
            }
        });
    })


</script>