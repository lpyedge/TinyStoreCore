<partial name="Widgets/_Plugin_Payment" />
<script src="https://cdn.staticfile.org/lodash.js/4.17.19/lodash.min.js"></script>
<script>
        var store = @Json.Serialize(ViewBag.Store);
        var productlist =  @Json.Serialize(ViewBag.ProductList);
        var product = @Json.Serialize(ViewBag.Product);

    $(function () {
        if (!store.IsSingle) {
            $("#homeheader").show();
            $(".store-header").addClass("store-header-withhome");
        }
            $.qqservice(store.QQ);

        RenderStoreInfo();
        
        RenderProducts();

            //数量加减
        $("#OrderQty").parent().click(function (e) {
                var $t = $(e.target);
            var newval = Math.abs(parseInt($("#OrderQty").val()));
                if ($t.attr("name") == "minus") {
                    newval = newval - 1;
                } else if ($t.attr("name") == "plus"){
                    newval = newval + 1;
                }
                if (newval < 1) {
                    newval = 1;
                }
                if (product.StockNumber != -1 && newval > product.StockNumber) {
                    newval = product.StockNumber;
                }
            $("#OrderQty").val(newval);
                SetPriceAndAmount();
            });

        $("#OrderQty").on("blur", function (event) {
                event = CY.EventFix(event);
                CY.StopPropagation(event);
                var target = event.target;
                var newVal = $(target).val();
                SetPriceAndAmount();
            });

            $("#OrderUniqueId").on("blur", V_Contact);

            $("#OrderNotice").on("blur", V_Notice);

            //
            $("#OrderPlace").on("click", function () {
                if (!product) {
                    $.toast("请选择商品");
                }
                else if ($("#OrderQty").val().ParseInt() <= 0) {
                    $.toast("请修改商品数量");
                }
                else if (product.StockNumber >= 0 && product.StockNumber < product.QuantityMin) {
                    $.toast("库存不足");
                }
                else if (!V_Contact() || !V_Notice()) {
                    console.log("V_Contact","V_Notice")
                }else {
                    Payment.Show(product.ProductId, $("#OrderQty").val(),$("#OrderUniqueId").val(),$("#OrderNotice").val());
                }
            });

        });

    function RenderStoreInfo() {
        $("#storename").text(store.Name);
        $("#storememo").text(store.Memo);
        $("#storelogo").prop("src", store.Logo);
    }

        function GetProductModel(productid) {
            if (productlist && productlist.length > 0) {
                for (var i = 0; i < productlist.length; i++) {
                    if (productlist[i].ProductId == productid) {
                        return productlist[i];
                    }
                }
            }
            return null;
        }



        function RenderProductInfo() {
            if (product) {
                if (product.StockNumber == -1 || product.DeliveryType != @((int)TinyStore.EDeliveryType.卡密)) {
                    $("#ProductStock").hide();
                } else {
                    $("#ProductStock").show();
                    $("#ProductStockQty").html(product.StockNumber + "件");
                }
                $("#OrderQty").val(product.StockNumber != 0 ? 1 : 0);
                $("#ProductName").text(product.Name);
                $("#ProductIcon").prop("src", product.Icon);
                $("#ProductPrice").html('￥' + product.Amount.Format0(2));
                $("#ProductMemo").html(product.Memo.replace(/\n/ig, '<br/>'));
            }
        }

        function SetPriceAndAmount() {
            if (product) {
                var qty = $("#OrderQty").val().ParseInt();
                if (product.StockNumber == 0) {
                    $("#add").prop("disabled", true);
                }
                if (product.DeliveryType == @((int)TinyStore.EDeliveryType.卡密) && product.StockNumber >= 0 && product.StockNumber > product.QuantityMin) {
                    if (qty < product.QuantityMin) {

                        $.toast("下单数量不能少于" + product.QuantityMin);
                        qty = product.QuantityMin;
                        $("#OrderQty").val(qty);
                    } else if (qty > product.StockNumber) {
                        $.toast("下单数量不能大于" + product.StockNumber);
                        qty = product.StockNumber;
                        $("#OrderQty").val(qty);
                    }
                }

                $("#OrderAmount").html('￥' + (product.Amount * qty).Format0(2));
            }
        }



        function V_Contact() {
            if ($("#OrderUniqueId").val() == "") {
                $.toast("角色编号不能为空");
                return false;
            }
            return true;
        }

        function V_Notice() {
            res = false;
            if ($("#OrderNotice").val() == "") {
                $.toast("邮箱不能为空");
            } else {
                if (CY.Regex.IsEmail($("#OrderNotice").val())) {
                    res = true;
                } else {
                    $.toast("邮箱格式不正确");
                }
                return res;
            }
        }

</script>