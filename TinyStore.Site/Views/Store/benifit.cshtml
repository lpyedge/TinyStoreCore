<div class="benifit">
    <h4 class="mb-3  bd-text-purple-bright">
        收益统计
    </h4>
    <div class="form-inline ">
        <label for="txtDateBegin">起始时间</label>
        <div class="input-group ">
            <input id="txtDateBegin" type="date" class="form-control" value="@DateTime.Now.AddDays(-7).ToString(SiteContext.Config.FormatDate)" />
        </div>
        <label for="txtDateEnd">结束时间</label>
        <div class="input-group">
            <input id="txtDateEnd" type="date" class="form-control" value="@DateTime.Now.ToString(SiteContext.Config.FormatDate)" />
        </div>
        <div class="input-group col-lg-2">
            <input id="chkIsHasReturn" type="checkbox" class="" /><label for="chkIsHasReturn">有退款</label>
        </div>
        <label>选择供货商</label>
        <div class="input-group ml-1">
            <select id="slSupplier" class="form-control">
                <option value="">不限</option>
                @*<%
                    foreach (var item in TinyStore.Helper.UserHandler.Supplier.GetAllList())
                    {
                    %>
                    <option value="<%=item.SId %>"><%=item.Name %></option>
                    <%
                    }%>*@
            </select>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-info" id="btnSearch">搜索</button>
        </div>
    </div>
    <table id="grid" class="table table-striped table-bordered" cellspacing="0" width="100%">
    </table>
    <div class="form-inline mt-2">
        <div class="col-4 col-md-2 mb-2">
            <label>总收入</label>
        </div>
        <div class="col-8 col-md-4 mb-2">
            <div class="input-group ">
                <input id="txtIncome" type="text" class="form-control" readonly="readonly" />
            </div>
        </div>
        <div class="col-4 col-md-2 mb-2">
            <label>总退款</label>
        </div>
        <div class="col-8 col-md-4 mb-2">
            <div class="input-group ">
                <input id="txtReturnAmount" type="text" class="form-control" readonly="readonly" />
            </div>
        </div>
    </div>
    <div class="form-inline">
        <div class="col-4 col-md-2 mb-2">
            <label>总支出</label>
        </div>
        <div class="col-8 col-md-4 mb-2">
            <div class="input-group ">
                <input id="txtCost" type="text" class="form-control" readonly="readonly" />
            </div>
        </div>
    </div>
    <div class="form-inline">
        <div class="col-4 col-md-2 mb-2">
            <label>总手续费</label>
        </div>
        <div class="col-8 col-md-4 mb-2">
            <div class="input-group ">
                <input id="txtPaymentFee" type="text" class="form-control" readonly="readonly" />
            </div>
        </div>
        <div class="col-4 col-md-2 mb-2">
            <label>退款返还</label>
        </div>
        <div class="col-8 col-md-4 mb-2">
            <div class="input-group ">
                <input id="txtPaymentFeeReturn" type="text" class="form-control" readonly="readonly" />
            </div>
        </div>
    </div>
    <div class="form-inline">
        <div class="col-4 col-md-2 mb-2">
            <label>毛利润</label>
        </div>
        <div class="col-8 col-md-4 mb-2">
            <div class="input-group ">
                <input id="txtProfitGross" type="text" class="form-control" readonly="readonly" />
            </div>
        </div>
        <div class="col-4 col-md-2 mb-2">
            <label>纯利润</label>
        </div>
        <div class="col-8 col-md-4 mb-2">
            <div class="input-group ">
                <input id="txtProfit" type="text" class="form-control" readonly="readonly" />
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script>
    var estate = @Json.Serialize(Global.EnumsDic<EState>());
    if (user) {
    }
    else {
        location.href = "/user/login";
    }

    $(function () {
        QueryPageList();
        $("#btnSearch").on("click", QueryPageList);
    });

    var grid = $('#grid').bootstrapTable(
        $.extend(baseTableoption, {
            uniqueId: "OrderId",
            columns: [{
                title: '订单编号',
                events: {
                    "click [name='shortlink']": function (e, value, row, index) {
                        UrlShortShow(row.OrderId);
                    }
                },
                formatter: function (value, row, index) {
                    return row.OrderId
                        + "<button name='shortlink' title='短链接' orderid=\"" + row.OrderId + "\" class=\"btn-link btn-sm\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i>获取</button>"
                        + "<br/>" + row.Name;
                }
            }, {
                title: '订单款项', formatter: function (value, row, index) {
                    var title = "收款";
                    if (row.ReturnAmount > 0)
                        title += "-退款";
                    if (row.CostFee == 0)
                        title += "-成本";
                    else
                        title += "-(成本+手续费)";
                    title += "=毛利润";
                    var html = "<a class='btn btn-outline-success ml-1' style='min-width:7rem;' title='" + title + "' href='#'>";
                    html += row.Income.Format0(2);
                    var profitGross = row.Income;
                    if (row.ReturnAmount > 0) {
                        html += " - " + row.ReturnAmount.Format0(2);
                        profitGross -= row.ReturnAmount;
                    }

                    if (row.CostFee == 0) {
                        html += " - " + row.Cost.Format0(2);
                        profitGross -= row.Cost;
                    }
                    else {
                        html += " - (" + row.Cost.Format0(2) + " + " + row.CostFee.Format0(2) + ") ";
                        profitGross -= row.CostFee + row.Cost;
                    }

                    html += " = " + profitGross.Format0(2);
                    html += "</a>";
                    return html;
                }
            }, {
                title: '状态', formatter: function (value, row, index) {
                    return "<label class='badge badge-success'>" + estate[row.State] + "</label>";
                }
            }, {
                title: '支付方式', formatter: function (value, row, index) {
                    if (row.PaymentType == 3)
                        return "<label class='badge badge-info'>支 PC</label>";
                    //else if (row.PaymentType == "微信扫码支付")
                    else if (row.PaymentType == 2)
                        return "<label class='badge badge-success'><i class='fa fa-weixin'></i> PR</label>";
                    //else if (row.PaymentType == "银行付款")
                    //    return "<label class='badge badge-warning'><i class=\"fa fa-credit-card\"></i></label>";
                    //else if (row.PaymentType == "支付宝扫码支付")
                    else if (row.PaymentType == 1)
                        return "<label class='badge badge-info'>支 PR</label>";
                    else if (row.PaymentType == 4)
                        return "<label class='badge badge-success'><i class='fa fa-weixin'></i> H5</label>";
                    //else if (row.PaymentType == "微信公众号支付")
                    //    return "<label class='badge badge-success'><i class='fa fa-weixin'></i> 公众号</label>";
                    else if (row.PaymentType == 5)
                        return "<label class='badge badge-info'>支 Wap</label>";
                    return "";
                }
            }, {
                field: 'LastUpdateDate_str',
                title: '最终变动时间', formatter: function (value, row, index) {
                    return DatetimeFormat(row.LastUpdateDate);
                }
            }]
        })
    );
    QueryPageList = function () {
        var gridopt = grid.bootstrapTable("getOptions");
        CY.Ajax("OrderPageListBenifit", {
            Token: Store.Token()
            }, {
            storeId: storeid,
            sid: $("#slSupplier").val(),
            begin: $("#txtDateBegin").val(),
            end: $("#txtDateEnd").val(),
            ishasreturn: $("#chkIsHasReturn").prop("checked"),
            pageindex: gridopt.pageNumber,
            pagesize: gridopt.pageSize
        }, function (msg) {
            grid.bootstrapTable('load', msg.Data);
            $("#txtIncome").val("￥" + msg.Data.footer.Income.Format0(2));
            $("#txtReturnAmount").val("￥" + msg.Data.footer.ReturnAmount.Format0(2));
            $("#txtCost").val("￥" + msg.Data.footer.Cost.Format0(2));
            $("#txtPaymentFee").val("￥" + msg.Data.footer.PaymentFee.Format0(2));
            $("#txtPaymentFeeReturn").val("￥" + msg.Data.footer.PaymentFeeReturn.Format0(2));
            $("#txtProfitGross").val("￥" + msg.Data.footer.ProfitGross.Format0(2));
            $("#txtProfit").val("￥" + msg.Data.footer.Profit.Format0(2));
        });
        }

    </script>
}
