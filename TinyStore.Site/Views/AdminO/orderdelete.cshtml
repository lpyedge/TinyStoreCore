<div class="col">
    <p class="mb-3  bd-text-purple-bright">
        订单回收站
    </p>
    <div class="form-inline ">
        <label for="txtDateBegin">起始时间</label>
        <div class="input-group ">
            <input id="txtDateBegin" type="date" class="form-control" value="@DateTime.Now.AddDays(-7).ToString(SiteContext.Config.FormatDate)" />
        </div>
        <label for="txtDateEnd">结束时间</label>
        <div class="input-group">
            <input id="txtDateEnd" type="date" class="form-control" value="@DateTime.Now.ToString(SiteContext.Config.FormatDate)" />
        </div>
        <div class="col-2">
            <select class="form-control" id="slState">
                <option value="0">请选择订单状态</option>
                @foreach (TinyStore.EState state in Enum.GetValues(typeof(TinyStore.EState)))
                {
                    <option value="@((int)state)">@state</option>
                }
            </select>
        </div>
        <div class="col-4">
            <select class="form-control" id="slKey">
                @foreach (TinyStore.EOrderSearchKey key in Enum.GetValues(typeof(TinyStore.EOrderSearchKey)))
                {
                    <option value="@((int)key)">@key</option>
                }
            </select>
            <input type="text" class="form-control" id="txtKey" />
        </div>
    </div>
    <div class="form-inline mt-2">
        <div class="col-10">
        </div>
        <div class="col-2">
            <button class="btn btn-info" id="btnSearch">搜索</button>
        </div>
    </div>
    <table id="grid" class="table table-striped table-bordered" cellspacing="0" width="100%">
    </table>
</div>
<div id="dialog">
    <form>
        <div class="jumbotron">
            <div class="form-group form-inline row ">
                <h6 class="col-12 control-label bd-text-purple-bright">订单相关</h6>
            </div>
            <div class="form-group form-inline row ">
                <label class="col-lg-3 control-label">订单号</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="OrderId" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">订单状态</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="State" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">下单数量</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="Quantity" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">支付方式</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="PaymentType" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">进货成本</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="Cost" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row Discount">
                <label class="col-lg-3 control-label">订单金额</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="OrderAmount" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row IsDiscount">
                <label class="col-lg-3 control-label">优惠金额</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="Discount" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">联系方式</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="Contact" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row NoticeAccount">
                <label class="col-lg-3 control-label">通知账户</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="NoticeAccount" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row IsPay">
                <label class="col-lg-3 control-label">交易编号</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="TranId" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">下单时间</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="CreateDate" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">最后变动</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="LastUpdateDate" readonly="readonly" />
                </div>
            </div>
        </div>
        <div class="jumbotron">
            <div class="form-group form-inline row">
                <h6 class="col-12 control-label bd-text-purple-bright">产品相关</h6>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">商品名称</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="Name" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row IsDiscount">
                <label class="col-lg-3 control-label">商品原价</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="ProductAmountO" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">商品单价</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="ProductAmount" readonly="readonly" />
                </div>
            </div>
            @*<div class="form-group form-inline row IsDiscount">
                    <label class="col-lg-3 control-label">折扣说明</label>
                    <div class="col-8">
                        <textarea name="DiscountInfo" class="form-control" rows="3" readonly="readonly"></textarea>
                    </div>
                </div>*@
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">商品简介</label>
                <div class="col-8">
                    <textarea name="Memo" class="form-control" rows="3" readonly="readonly"></textarea>
                </div>
            </div>
        </div>
        <div class="jumbotron IsDelivery">
            <div class="form-group form-inline row">
                <h6 class="col-12 control-label bd-text-purple-bright">发货相关</h6>
            </div>
            <div class="form-group form-inline row ">
                <label class="col-lg-3 control-label">发货时间</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="DeliveryDate" readonly="readonly" />
                </div>
            </div>
        </div>
        <div class="jumbotron IsReturn">
            <div class="form-group form-inline row">
                <h6 class="col-12 control-label bd-text-purple-bright">退款相关</h6>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label ReturnAmount">退款金额</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="ReturnAmount" readonly="readonly" />
                </div>
            </div>
            <div class="form-group form-inline row">
                <label class="col-lg-3 control-label">退款时间</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="ReturnDate" readonly="readonly" />
                </div>
            </div>
        </div>
        <div class="jumbotron IsClose">
            <div class="form-group form-inline row">
                <h6 class="col-12 control-label bd-text-purple-bright">结算相关</h6>
            </div>
            <div class="form-group form-inline row ">
                <label class="col-lg-3 control-label">结算时间</label>
                <div class="col-8">
                    <input type="text" class="form-control" name="SettleDate" readonly="readonly" />
                </div>
            </div>
        </div>
    </form>
</div>
@section Scripts{
    <script>
        var dialog;
        var list = null;
        var grid = $('#grid').bootstrapTable(
            $.extend(baseTableoption, {
                uniqueId: "Id",
                columns: [{
                    title: '订单编号',
                    formatter: function (value, row, index) {
                        return row.OrderId
                            "<br/>" + row.Name;
                    }
                }, {
                    field: 'StoreName',
                    title: '店铺名称', formatter: function (value, row, index) {
                        return '<a href="/'+row.UniqueId+'" target=\"_blank\" class=\"btn-link btn-sm\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i>' + row.StoreName + '</a>';
                    }
                }, {
                    title: '订单款项', formatter: function (value, row, index) {
                        var html = "";
                        if (row.IsSettle)
                            html += "<label class='badge badge-success' title='已结算'><i class=\"fa fa-check\"></i></label>";
                        else
                            html += "<label class='badge badge-danger' title='未结算'><i class=\"fa fa-times\"></i></label>";

                        if (row.ReturnAmount)
                            html += "<a class='btn btn-outline-success ml-1' style='min-width:7rem;' title='收款-退款-成本=毛利润' href='#'>"
                        else
                            html += "<a class='btn btn-outline-success ml-1' style='min-width:7rem;' title='收款-成本=毛利润' href='#'>"
                        var profitGross = row.Income - row.Cost;  //毛利润
                        html += row.Income.Format0(2);
                        if (row.ReturnAmount) {
                            profitGross -= row.ReturnAmount;
                            html += " - " + row.ReturnAmount.Format0(2);
                        }
                        html += " - " + row.Cost.Format0(2);
                        html += " = " + profitGross.Format0(2);
                        html += "</a>";
                        return html;
                    }
                }, {
                    title: '状态', formatter: function (value, row, index) {
                        return "<label class='badge badge-success'>" + GetEnumName("slState", row.State) + "</label>";
                    }
                }, {
                    title: '支付方式', formatter: function (value, row, index) {
                        if (row.PaymentType == 3)
                            return "<label class='badge badge-info'>支 PC</label>";
                        //else if (row.PaymentType == "微信扫码支付")
                        else if (row.PaymentType == 2)
                            return "<label class='badge badge-success'><i class='fa fa-weixin'></i> PR</label>";
                        //else if (row.PaymentType == "银行付款")
                        //    return "<label class='badge badge-warning'><i class=\"fa fa-credit-card\"></i></label>";
                        //else if (row.PaymentType == "支付宝扫码支付")
                        else if (row.PaymentType == 1)
                            return "<label class='badge badge-info'>支 PR</label>";
                        else if (row.PaymentType == 4)
                            return "<label class='badge badge-success'><i class='fa fa-weixin'></i> H5</label>";
                        //else if (row.PaymentType == "微信公众号支付")
                        //    return "<label class='badge badge-success'><i class='fa fa-weixin'></i> 公众号</label>";
                        else if (row.PaymentType == 5)
                            return "<label class='badge badge-info'>支 Wap</label>";
                        return "";
                    }
                }, {
                    //field: 'LastUpdateDate_str',
                    title: '最终变动时间',
                    formatter: function (value, row, index) {
                        return DatetimeFormat(row.LastUpdateDate)
                    }

                }, {
                    title: '订单管理', formatter: function (value, row, index) {
                        return "<button onclick=\"OrderInfo('" + row.Id + "')\" class=\"btn-success btn-sm m-1\">订单明细</button>";
                    }
                }]
            })
        );
        QueryPageList = function () {
            var gridopt = grid.bootstrapTable("getOptions");
            CY.Ajax("OrderDeletePageList", {
                Token: Store.Token()
            }, {
                begin: $("#txtDateBegin").val(),
                end: $("#txtDateEnd").val(),
                state: $("#slState").val(),
                keykind: $("#slKey").val(),
                key: $("#txtKey").val(),
                pageindex: gridopt.pageNumber,
                pagesize: gridopt.pageSize
            }, function (msg) {
                grid.bootstrapTable('load', msg.Data);
                list = msg.Data.rows;
                var rule_tel = /^1[3,5,7,8]\d{9}$/g;
                $.each(list, function (index, order) {
                    //if (rule_tel.test(order.Contact))
                    //    order.Contact += "(电话)";
                    //else
                    //    order.Contact += "(QQ)";
                    var a = "sdsd";
                    if (order.NoticeAccount != "") {

                        if (rule_tel.test(order.NoticeAccount))
                            order.NoticeAccount += "(电话)";
                        else
                            order.NoticeAccount += "(邮箱)";
                    }
                    //order.Cost = order.Cost.Format0(2);
                    if (order.IsPay)
                        order.MoneyPay = (order.Amount + order.PaymentFee);
                    //order.ReturnAmount = order.ReturnAmount.Format0(2);
                });
            });
        }
        QueryPageList();

        function GetOrderModel(m_id) {
            var order = null;
            for (var i = 0; i < list.length; i++) {
                if (list[i].Id == m_id) {
                    order = list[i];
                    i = list.length;
                }
            }
            return order;
        }
        function OrderInfo(m_id) {
            var order = GetOrderModel(m_id);
            dialog = bootbox.dialog({
                show: false,
                title: "订单明细",
                message: $("#dialog").html()
            });
            if (order.NoticeAccount == "")
                dialog.find("form").find(".NoticeAccount").hide();
            else
                dialog.find("form").find(".NoticeAccount").show();
            if (order.IsPay)
                dialog.find("form").find(".IsPay").show();
            else
                dialog.find("form").find(".IsPay").hide();
            if (order.IsDelivery)
                dialog.find("form").find(".IsDelivery").show();
            else
                dialog.find("form").find(".IsDelivery").hide();
            if (order.IsSettle)
                dialog.find("form").find(".IsClose").show();
            else
                dialog.find("form").find(".IsClose").hide();
            if (order.ReturnAmount > 0)
                dialog.find("form").find(".IsReturn").show();
            else
                dialog.find("form").find(".IsReturn").hide();

            dialog.find("form").FormSet(order);
            dialog.find("form").find("[name='OrderAmount']").val("￥" + (order.Amount + order.Discount));
            dialog.find("form").find("[name='Discount']").val("￥" + order.Discount);
            if (order.Discount > 0)
                dialog.find("form").find(".IsDiscount").show();
            else
                dialog.find("form").find(".IsDiscount").hide();
            dialog.find("form").find("[name='ProductAmountO']").val("￥" + ((order.Amount + order.Discount) / order.Quantity).Format0(2));
            if (order.PromoCode != null) {
                dialog.find("form").find("[name='DiscountInfo']").val(order.PromoCode.Info + ", 你下单数量为" + order.Quantity + ", 因此产品现价为" + order.ProductAmount);
            }

            dialog.modal("show");
        }
        $("#dialog").hide();
        $("#btnSearch").on("click", QueryPageList);
    </script>
}
